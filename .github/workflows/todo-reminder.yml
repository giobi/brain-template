name: Todo Reminder

on:
  schedule:
    # Every day at 8:00 AM UTC
    - cron: '0 8 * * *'
  workflow_dispatch: # Allow manual trigger

jobs:
  check-todos:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Check for overdue and due todos
        id: check
        run: |
          TODAY=$(date +%Y-%m-%d)
          OVERDUE=""
          DUE_TODAY=""

          # Find all todo files
          if [ -d "todo" ]; then
            for file in todo/*.md; do
              if [ -f "$file" ]; then
                # Extract due date from filename (format: YYYY-MM-DD-*.md)
                FILENAME=$(basename "$file")
                if [[ $FILENAME =~ ^([0-9]{4}-[0-9]{2}-[0-9]{2}) ]]; then
                  DUE_DATE="${BASH_REMATCH[1]}"

                  # Check if overdue
                  if [[ "$DUE_DATE" < "$TODAY" ]]; then
                    TASK_NAME=$(echo "$FILENAME" | sed 's/^[0-9]\{4\}-[0-9]\{2\}-[0-9]\{2\}-//' | sed 's/.md$//' | tr '-' ' ')
                    OVERDUE="${OVERDUE}- ❌ **${TASK_NAME}** (due: ${DUE_DATE})\n"
                  # Check if due today
                  elif [[ "$DUE_DATE" == "$TODAY" ]]; then
                    TASK_NAME=$(echo "$FILENAME" | sed 's/^[0-9]\{4\}-[0-9]\{2\}-[0-9]\{2\}-//' | sed 's/.md$//' | tr '-' ' ')
                    DUE_TODAY="${DUE_TODAY}- ⏰ **${TASK_NAME}** (due today!)\n"
                  fi
                fi
              fi
            done
          fi

          # Prepare message
          MESSAGE=""
          if [ -n "$OVERDUE" ]; then
            MESSAGE="${MESSAGE}🚨 **OVERDUE TODOS**\n${OVERDUE}\n"
          fi
          if [ -n "$DUE_TODAY" ]; then
            MESSAGE="${MESSAGE}📅 **DUE TODAY**\n${DUE_TODAY}\n"
          fi

          if [ -n "$MESSAGE" ]; then
            echo "has_todos=true" >> $GITHUB_OUTPUT
            # Escape for JSON
            MESSAGE=$(echo -e "$MESSAGE" | sed ':a;N;$!ba;s/\n/\\n/g')
            echo "message=$MESSAGE" >> $GITHUB_OUTPUT
          else
            echo "has_todos=false" >> $GITHUB_OUTPUT
            echo "All clear! No overdue or due todos today ✅"
          fi

      - name: Send Telegram notification
        if: steps.check.outputs.has_todos == 'true'
        run: |
          MESSAGE="${{ steps.check.outputs.message }}"
          curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
            -d chat_id="${{ secrets.TELEGRAM_CHAT_ID }}" \
            -d parse_mode="Markdown" \
            -d text="🧠 **Brain Todo Reminder**

          $MESSAGE

          Check your brain/todo/ directory!"
